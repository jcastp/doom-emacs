#+TITLE: doom personal config
#+AUTHOR: Javier Castilla
#+EMAIL: jcastp@pm.me
#+startup: overview
#+language: en
* General config
** Lexical binding tagging
#+begin_src emacs-lisp
;;; config.el -*- lexical-binding: t; -*-
#+end_src

** System information
Variables to conditional load based on systems or locations.

*** based on machine names
Defining variables for conditional execution, based on machines:

#+begin_src emacs-lisp
;; working laptop vm
(defvar my-worksystem-p (equal (system-name) "ESZAR1N1640"))
;; My desktop machine, able to run anything
(defvar my-desktopsystem-p (equal (system-name) "olimpo"))
;; Writing machines, probably we can strip some features
(defvar my-writinglaptop-p
  (or (equal (system-name) "argos") (equal (system-name) "caliope"))
  )
#+end_src

*** based on environment variables
Home and Work environment.

#+begin_src emacs-lisp
(defvar my-workenvironment-p (string= (getenv "WORKING") "WORK"))
(defvar my-homeenvironment-p (string= (getenv "WORKING") "HOME"))
#+end_src

** Personal information
Based on the environment variables.

#+begin_src emacs-lisp
(if (not my-workenvironment-p)
    ;; then part - personal use
    (progn
      (setq user-full-name "Javier Castilla"
            user-mail-address "jcastp@pm.me")
      )
  ;; else part - work use
  (progn
    (setq user-full-name "Francisco Javier Castilla"
          user-mail-address "franciscojavier.castilla@adidas.com")
    )
  )
#+end_src

** Configure the config and data directories
- Config directory contains the files that will be commited. All the files that will get emacs up and running will be here.
- Data directory contains the files that should no be commited, but contains my own information, that is useful.
We will be using this either with concat or expand-file-name:
- expand-file-name for when we have just a filename
- concat for when we have a composite directory and filename, or as a secondary way to do it.
#+begin_src emacs-lisp
;; this is the same as the doom-user-dir
(defvar my-config-dir "~/.doom.d/")
;; where the files I can sync live
(defvar my-data-dir "~/Nextcloud/config/.emacs.d/")
#+end_src

** free-keys
To know which keys are still free.

#+begin_src emacs-lisp :tangle packages.el
(package! free-keys
  :recipe (:host github :repo "Fuco1/free-keys"))
#+end_src

** Movement
Some keys redefined to better adjust to the whole emacs key environment.

#+begin_src emacs-lisp
(global-set-key (kbd "M-p") 'backward-paragraph)
(global-set-key (kbd "M-n") 'forward-paragraph)
#+end_src

** auto revert mode
When a file is changed in disk, the buffer reloads to reflect that change.

#+begin_src emacs-lisp
(global-auto-revert-mode 1)
#+end_src

Change dired buffers when the directory is changed:

#+begin_src emacs-lisp
;; auto refresh dired when file changes
(add-hook! 'dired-mode-hook 'auto-revert-mode)
#+end_src

** Bookmarks
All the config related to the bookmarks.

#+begin_src emacs-lisp
;;(setq bookmark-default-file "~/Nextcloud/config/.emacs.d/bookmarks")  ;;define file to use.
(setq bookmark-default-file (expand-file-name "bookmarks" my-data-dir))
(setq bookmark-save-flag 1)  ;save bookmarks to .emacs.bmk after each entry
#+end_src

** Set firefox as the default browser
Setting firefox as the default browser.

#+begin_src emacs-lisp
(setq browse-url-firefox-program "firefox")
(setq browse-url-browser-function 'browse-url-firefox)
#+end_src

** openwith
Open particular files with external applications.

#+begin_src emacs-lisp :tangle packages.el
(package! openwith
  :recipe (:host github :repo "garberw/openwith"))
#+end_src

#+begin_src emacs-lisp
(when (require 'openwith nil 'noerror)
  (setq openwith-associations
        (list
         ;; videos
         (list (openwith-make-extension-regexp
                '("mpg" "mpeg" "mp3" "mp4"
                  "avi" "wmv" "wav" "mov" "flv"
                  "ogm" "ogg" "mkv"))
               "vlc"
               '(file))
         ;; office documents
         (list (openwith-make-extension-regexp
                '("doc" "docx" "xls" "xlsx" "ppt" "pptx"
                  "odt" "ods" "odg" "odp" "fodg"
                  "fods" "fodt"))
               "libreoffice"
               '(file))
         ;; help documents
         '("\\.lyx" "lyx" (file))
         '("\\.chm" "kchmviewer" (file))
         ;; pdf files
         ;; (list (openwith-make-extension-regexp
         ;;        '("pdf" "ps" "ps.gz" "dvi" "epub"))
         ;;       "okular"
         ;;       '(file))
         ))
  (openwith-mode 1)
  )
#+end_src

** pdf tools install
To open pdfs in emacs, we need to compile the pdf-tools.

#+begin_src emacs-lisp
(pdf-tools-install)
#+end_src
** Start maximized
#+begin_src emacs-lisp
(add-to-list 'default-frame-alist '(fullscreen . maximized))
#+end_src

** persp mode config
My personal config for persp mode.

#+begin_src emacs-lisp
;;(setq persp-save-dir (expand-file-name "persp-confs/" my-data-dir))
(after! persp-mode
  ;;(setq persp-save-dir "~/Nextcloud/config/.emacs.d/persp-confs/")
  (setq persp-save-dir "/home/jcastp/Nextcloud/config/.emacs.d/persp-confs/")
)
#+end_src
** recentf config
Where I want to store the recent files I visited.

#+begin_src emacs-lisp
(recentf-mode t)
(setq recentf-save-file (expand-file-name "recentf" my-data-dir))
#+end_src
* Editing
** Undo
Unbind C-z and use it for the "undo".

#+begin_src emacs-lisp
(global-unset-key (kbd "C-z"))
(global-set-key (kbd "C-z") #'undo)
#+end_src

** Abbreviation mode
Defines a set of abbreviations that permits complete words with just some characters.

#+begin_src emacs-lisp
;;where do we read the abbrevs from
;;(setq abbrev-file-name "~/Nextcloud/config/.emacs.d/abbrev_defs")
(setq abbrev-file-name (expand-file-name "abbrev_defs" my-data-dir))
(setq-default abbrev-mode t)
;; save abbrevs when files are saved
(setq save-abbrevs 'silent)
#+end_src

** Flyspell mode
Automatic spelling in the buffer
This conflicts with orgmode archive C-c $
https://www.gnu.org/software/emacs/manual/html_node/emacs/Spelling.html

#+begin_src emacs-lisp
(add-hook! 'text-mode-hook 'flyspell-mode)
(global-font-lock-mode t)
;; custom location of the dictionary
(setq ispell-personal-dictionary (expand-file-name "dict" my-data-dir))
;;(setq ispell-personal-dictionary "~/Nextcloud/config/.emacs.d/dict")
;; save the dictionary without asking
(setq ispell-silently-savep t)
#+end_src

** electric pair mode
To automatically close parenthesis and and other punctuation signs.

#+begin_src emacs-lisp
(electric-pair-mode 1)
;; make electric-pair-mode work on more sets of punctuation signs.
(setq electric-pair-pairs
      '(
        (?\¡ . ?\!)
        (?\¿ . ?\?)
        )
      )

(setq electric-pair-inhibit-predicate
      `(lambda (c)
         (if (char-equal c ?<) t (,electric-pair-inhibit-predicate c)))
      )
#+end_src

** yasnippet
*** yasnippet load custom directories
Modify yas-snippet-dirs to add my own snippets.
#+begin_src emacs-lisp
(add-to-list 'yas-snippet-dirs "/home/jcastp/Nextcloud/config/.emacs.d/snippets/" t)
#+end_src

* UI


** Define fonts
Define the fonts for Doom emacs.
There are fixed and variable pitch fonts to define.

#+begin_src emacs-lisp
(setq
  ;; Font used for source code
  ;;doom-font (font-spec :family "JetBrains Mono" :size 14 :weight 'Medium)
  doom-font (font-spec :family "Fira Code" :size 14 :weight 'Medium)
  ;; doom-font (font-spec :family "Hasklig" :size 16 :weight 'Medium)
  ;; doom-font (font-spec :family "Iosevka Fixed" :size 16 :weight 'Medium)
  ;; doom-font (font-spec :family "Hack" :size 14)

  ;; Font used for normal writing
  ;;doom-variable-pitch-font (font-spec :family "Gentium Basic" :size 18)
  ;;doom-variable-pitch-font (font-spec :family "ETBookOT" :size 18)
  ;;doom-variable-pitch-font (font-spec :family "ETBembo" :size 18)

  ;;;; When you want to have a fixed font for the variable one
  doom-variable-pitch-font (font-spec :family "Fira Code" :size 14 :weight 'Medium)
  ;;doom-variable-pitch-font (font-spec :family "JetBrains Mono" :size 16 :weight 'Extralight)
  ;;doom-variable-pitch-font (font-spec :family "JetBrains Mono" :size 18 :weight 'Light)
  ;;doom-variable-pitch-font (font-spec :family "Iosevka" :size 26 :weight 'Regular)
  ;;doom-variable-pitch-font (font-spec :family "Iosevka")
  )
#+end_src

For when I want mixed pitch mode in org mode.

#+begin_src emacs-lisp
;;(add-hook! 'org-mode-hook #'mixed-pitch-mode)
#+end_src
** fontaine
I can change the fonts with just a single command.
https://protesilaos.com/emacs/fontaine

#+begin_src emacs-lisp :tangle packages.el
(package! fontaine
  :recipe (:host github :repo "protesilaos/fontaine"))
#+end_src

Here will come the code for the fontaine package.
#+begin_src emacs-lisp
(after! fontaine
(setq fontaine-presets
      '(
        ;; daily operations, same config as normal config
        (regular
         :default-family "Fira Code"
         :default-weight normal
         :default-height 110
         :fixed-pitch-family "Fira Code"
         :fixed-pitch-weight Medium ; falls back to :default-weight
         :fixed-pitch-height 110
         :variable-pitch-family "Fira Code"
         :variable-pitch-weight normal
         :variable-pitch-height 110
         :bold-family nil ; use whatever the underlying face has
         :bold-weight bold
         :italic-family "Iosevka"
         :italic-slant italic
         :line-spacing 1
         )
        ;; Bigger face for variable width, so I can focus on it
        (writing
         :default-family "EB Garamond"
         :default-weight normal
         :default-height 150
         :fixed-pitch-family "Iosevka"
         :fixed-pitch-weight Medium ; falls back to :default-weight
         :fixed-pitch-height 110
         :variable-pitch-family "ETBembo"
         :variable-pitch-weight Medium
         :variable-pitch-height 200
         :bold-family nil ; use whatever the underlying face has
         :bold-weight bold
         :italic-family "EB Garamond"
         :italic-slant italic
         :line-spacing 1
         )
        ;; change the variable width face to have a different view when editing
        (editing
         :default-family "Iosevka"
         :default-weight normal
         :default-height 130
         :fixed-pitch-family "Iosevka"
         :fixed-pitch-weight nil ; falls back to :default-weight
         :fixed-pitch-height 110
         :variable-pitch-family "Gentium"
         :variable-pitch-weight normal
         :variable-pitch-height 180
         :bold-family nil ; use whatever the underlying face has
         :bold-weight bold
         :italic-family "Iosevka"
         :italic-slant italic
         :line-spacing 1
         )
        ;; change the variable width face to have a different view when editing
        (variable-width
         :default-family "Fira Code"
         :default-weight normal
         :default-height 130
         :fixed-pitch-family "Iosevka"
         :fixed-pitch-weight nil ; falls back to :default-weight
         :fixed-pitch-height 110
         :variable-pitch-family "ETBembo"
         :variable-pitch-weight normal
         :variable-pitch-height 180
         :bold-family nil ; use whatever the underlying face has
         :bold-weight bold
         :italic-family "Iosevka"
         :italic-slant italic
         :line-spacing 1
         )
        ;; For when I want to go back to all fixed width
        (fixed-width
         :default-family "Iosevka"
         :default-weight normal
         :default-height 130
         :fixed-pitch-family "Iosevka"
         :fixed-pitch-weight Medium ; falls back to :default-weight
         :fixed-pitch-height 110
         :variable-pitch-family "Iosevka"
         :variable-pitch-weight Medium
         :variable-pitch-height 130
         :bold-family nil ; use whatever the underlying face has
         :bold-weight bold
         :italic-family "Iosevka"
         :italic-slant italic
         :line-spacing 1

         )
        )
      )
)
#+end_src

** Font size increase/decrease
Increase or decrease the font size.

#+begin_src emacs-lisp
(global-set-key (kbd "M-+") 'text-scale-increase)
(global-set-key (kbd "M--") 'text-scale-decrease)
#+end_src

** ef-themes
Colorful themes.
https://github.com/protesilaos/ef-themes

#+begin_src emacs-lisp :tangle packages.el
(package! ef-themes
  :recipe (:host gitlab :repo "protesilaos/ef-themes"))
#+end_src
** poet theme
https://github.com/kunalb/poet

#+begin_src emacs-lisp :tangle packages.el
(package! poet
  :recipe (:host github :repo "kunalb/poet"))
#+end_src

** Initial theme
We establish the initial theme.

#+begin_src emacs-lisp
(consult-theme 'leuven)
#+end_src

** Pixel precision scroll
#+begin_src emacs-lisp
(pixel-scroll-precision-mode 1)
#+end_src

** full path in the title bar
Put the complete path on the title bar, along the filename.

#+begin_src emacs-lisp
(setq-default frame-title-format "%b - (%f)")
#+end_src

** Time and date
Put time and date on the status line

#+begin_src emacs-lisp
(setq display-time-day-and-date t
      display-time-24hr-format t)
(display-time)
#+end_src

** Open indirect buffer
Open a branch into a different frame, but the same buffer:

#+begin_src emacs-lisp
;; this is done to open the indirect buffer in another window
;; instead on the main one
(after! org
  (setq org-indirect-buffer-display 'other-window)

  (defun my/org-tree-open-in-right-frame ()
    (interactive)
    (org-tree-to-indirect-buffer)
    (windmove-right)
    )
  (global-set-key (kbd "C-c 8" ) 'my/org-tree-open-in-right-frame)
  )
#+end_src

** tab-bar-mode
tab-bar-mode seems to comply with all my requirements to store the configuration of the buffers and frames. This, coupled with desktop saving and restoring, can be the answer.

#+begin_src emacs-lisp
(tab-bar-mode 1)
;; Map the not mapped but useful functions
(global-set-key (kbd "C-x t s") 'tab-list)
(global-set-key (kbd "C-x t a") 'tab-recent)
#+end_src

** ace-window
Better selection character displayed.

#+begin_src emacs-lisp
(custom-set-faces!
  '(aw-leading-char-face
    :foreground "white" :background "red"
    :weight bold :height 2.5 :box (:line-width 10 :color "red")))
#+end_src

** Battery management
On laptops it's nice to know how much power you have.

#+begin_src emacs-lisp
(unless (string-match-p "^Power N/A" (battery))
  (display-battery-mode 1)
  )
#+end_src

** beacon
To see the cursor when moving.

#+begin_src emacs-lisp :tangle packages.el
(package! beacon
  :recipe (:host github :repo "Malabarba/beacon"))
#+end_src

#+begin_src emacs-lisp
(beacon-mode t)
(setq beacon-push-mark 35
      beacon-blink-duration 0.5
      beacon-blink-delay 0.5
      beacon-blink-when-focused t
      beacon-color "deep sky blue")
#+end_src
** Long lines get wrapped
Long lines get wrapped when they reach the edge. We activate it for all the buffers.

#+begin_src emacs-lisp
;; 1 for on, 0 for off.
(global-visual-line-mode 1)
#+end_src

** Fill column mode
We want to use the visual fill column mode to limit the width of the lines, even if they don't reach the right edge.

When reaching the established width defined, the line will wrap, even before getting into the right border of the application.

#+begin_src emacs-lisp :tangle packages.el
(package! visual-fill-column
  :recipe (:host codeberg :repo "joostkremers/visual-fill-column"))
#+end_src

#+begin_src emacs-lisp
;; This sets the value to all the buffers, as initially it is a per-buffer variable
(setq-default visual-fill-column-width 100)
;; enable it only for text buffers: org, text, ...
(add-hook 'text-mode-hook 'visual-fill-column-mode)
#+end_src

** Parens mode global
To show matching parens in all the buffers and modes.

#+begin_src emacs-lisp
(show-smartparens-global-mode 1)
#+end_src

* Navigation
** Uniquify
When several buffers visit identically-named files, Emacs must give the buffers distinct names. The usual method for making buffer names unique adds ‘<2>’, ‘<3>’, etc. to the end of the buffer names (all but one of them).

The forward naming method includes part of the file's directory name at the beginning of the buffer name
https://www.gnu.org/software/emacs/manual/html_node/emacs/Uniquify.html

#+begin_src emacs-lisp
(require 'uniquify)
(setq uniquify-buffer-name-style 'forward)
#+end_src

** Key chords
Shortcuts to commands using just quick key combinations.

#+begin_src emacs-lisp :tangle packages.el
(
 package! key-chord
  :recipe (:host github :repo "emacsorphanage/key-chord"))
#+end_src

#+begin_src emacs-lisp
(use-package key-chord
  ;;:quelpa (key-chord :fetcher github :repo "emacsorphanage/key-chord")
  ;;:ensure t
  :init
  (key-chord-mode 1)
  :config
  ;; Max time delay between two key presses to be considered a key chord
  (setq key-chord-two-keys-delay 0.1)
  ;; Max time delay between two presses of the same key to be considered a key chord.
  ;; Should normally be a little longer than `key-chord-two-keys-delay'.
  (setq key-chord-one-key-delay 0.2) ; default 0.2
  )
#+end_src

*** key chords for functions
Description of the configured key chords.

#+begin_src emacs-lisp
;; (key-chord-define-global "kk" 'other-window)
(key-chord-define-global "ññ" 'eshell)
(key-chord-define-global "hh" 'ace-window)
(key-chord-define-global "jj" 'avy-goto-char-2)
(key-chord-define-global "jl" 'avy-goto-line)
;;(key-chord-define-global "zz" 'undo-tree-visualize)
;;(key-chord-define-global "ww" 'hydra-move/body)
;;(key-chord-define-global "yy" 'hydra-buffer-mgmt/body)
#+end_src

** imenu-list
Better menus list

#+begin_src emacs-lisp :tangle packages.el
(package! imenu-list
  :recipe (:host github :repo "bmag/imenu-list"))
#+end_src

#+begin_src emacs-lisp
;; put the imenu in the position we want to
(setq imenu-list-position 'right)
;; Establish the depth of the entries shown
(setq org-imenu-depth 5)
;; map the keys
(global-unset-key (kbd "M-i"))
(global-set-key (kbd "C-c s I") #'imenu-list-smart-toggle)
;; Once you open imenu, focus on it
(setq imenu-list-focus-after-activation t)
#+end_src

** consult
Better search
#+begin_src emacs-lisp
(global-set-key (kbd "C-s") #'consult-line)
#+end_src

* Orgmode
** New priorities
Priorities from A to E, and with new colors:

#+begin_src emacs-lisp
;; (after! org
;;   (setq org-priority-highest ?A
;;         org-priority-lowest ?E
;;         org-priority-faces
;;         '((?A . 'all-the-icons-red)
;;           (?B . 'all-the-icons-orange)
;;           (?C . 'all-the-icons-yellow)
;;           (?D . 'all-the-icons-green)
;;           (?E . 'all-the-icons-blue))
;;         )
;;   )
#+end_src
** tag alignment
I want to have my tags justified to the right.

#+begin_src emacs-lisp
(after! org
  (setq org-tags-column -80)
)
#+end_src

** Custom notes and timestamp
Put a note or a timestamp when something changes. For example:
- When the tasks is marked as DONE
- When the schedule or deadline date is changed

#+begin_src emacs-lisp
(after! org
  ;; Adds a timestamp to the state
  (setq org-log-done 'time)

  ;; Adds a custom note to the state
  (setq org-log-done 'note)

  ;; When the deadline or the schedule date is moved.
  ;; to keep track of how many times I have moved a task to the future.
  (setq org-log-redeadline (quote time))
  (setq org-log-reschedule (quote time))
)
#+end_src

** Custom states for the tasks
These are the custom states for the tasks, and the character associated to it.

#+begin_src emacs-lisp
(after! org
  (setq org-todo-keywords
        '(
          ;; Status for tasks
          (sequence "TODO(t)" "ONGOING(r!)" "WAITING(w@/!)" "|" "DONE(d!)" "CANCELED(c@/!)")
          ;; Status for writing
          (sequence "TOWRITE(y)" "TOREVIEW(u@/!)" "REDO(i@/!)" "|" "FINISHED(o!)" "PURGE(p@/!)")
          )
        )
  )
#+end_src

** orgmode Agenda
All the agenda configs

*** Agenda files
We define the agenda files in this variable

#+begin_src emacs-lisp
(after! org
  (setq org-agenda-files '(
                           ;; normal task files
                           "~/Nextcloud/agenda/tasks.org"
                           "~/Nextcloud/agenda/inbox.org"
                           )
        )
  )
#+end_src

*** Get rid of the DONE tasks in the agenda view
We dont want the cluttering in our views. If a task is done, don't show it on the agenda view.

#+begin_src emacs-lisp
(after! org
  (setq org-agenda-skip-scheduled-if-done t)
  (setq org-agenda-skip-deadline-if-done t)
  (setq org-agenda-skip-timestamp-if-done t)
  )
#+end_src

*** TODO Custom agenda commands
We define some agenda custom commands, to refine views, and get a clearer undestanding of the tasks.

#+begin_src emacs-lisp
(after! org
  (setq org-agenda-custom-commands
       '(
         ;;;;;;;;;;;;;;;;;;;;;;;;;;;
         ; Custom agenda commands
         ;;;;;;;;;;;;;;;;;;;;;;;;;;;
         ("c" . "My Custom Agendas")

         ;; All the unescheduled tasks
          ("cu" "Unscheduled TODO"
            ((tags-todo "-backlog"
                  ((org-agenda-overriding-header "\nUnscheduled TODO")
                   (org-agenda-skip-function '(org-agenda-skip-entry-if 'timestamp)))))
              nil
           nil)

          ;; All the HIGH priority tasks, no backlog
           ("ch" "high priority tasks"
             (
               (tags-todo "+PRIORITY=\"A\"-backlog"
                  (
                   (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                   (org-agenda-overriding-header "High-priority unfinished tasks:")
                   )

                  )

               )
             )

           ;; All tasks, sorted and grouped
           ("ct" "all tasks, sorted"
             (
              ;; High priority tasks, no backlog
              (
               tags-todo "+PRIORITY=\"A\"-backlog"
                  (
                    (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))
                    (org-agenda-overriding-header "High-priority unfinished tasks:")
                    (org-agenda-prefix-format " %10c %5e ")

                    )
                  )
              ;; Ongoing tasks that needs effort from my side
              (tags-todo "-backlog-books/ONGOING"
                (
                 (org-agenda-overriding-header "Ongoing tasks:")
                 (org-agenda-prefix-format " %10c %5e ")
                 )
                )

              ;; Tasks scheduled today
              (agenda ""
                   (
                    (org-agenda-time-grid nil)
                    (org-schedule-warning-days 1)        ;; [1]
                    (org-agenda-entry-types '(:scheduled))  ;; [2]
                    (org-agenda-overriding-header "Scheduled today tasks:")
                    (org-agenda-prefix-format " %10c %5e ")
                    )
                   )

              ;; Tasks that are waiting on something
              (tags-todo "-backlog-books/WAITING"
                (
                 (org-agenda-overriding-header "Waiting tasks:")
                 (org-agenda-prefix-format " %10c %5e ")
                 )
                )

              ;; Tasks still not started, that are not high priority
              (tags-todo "-backlog-books-calendar +PRIORITY={B\\|C}/TODO"
                (
                 (org-agenda-overriding-header "TODO tasks:")
                 (org-agenda-prefix-format " %10c %5e ")
                 )
                )

              ;; Calendar tasks
              (tags-todo "calendar"
                (
                 (org-agenda-overriding-header "Calendar tasks:")
                 (org-agenda-prefix-format " %10c %5e ")
                 )
                )

              ;; Stuck tasks and projects
              (stuck ""
                (
                 (org-agenda-overriding-header "Stuck tasks:")
                 (org-agenda-prefix-format " %10c %5e ")
                 )
                )

              ;; end configuration all tasks sorted and grouped
              )
             )

           ;;;;;;;;;;;;
           ;; Time based queries
           ;;;;;;;;;;;;
           ;; 'In a day' tasks
           ("d" "Today"
             (
              (agenda "" ((org-agenda-span 1)
                          (org-agenda-sorting-strategy
                           (quote ((agenda time-up priority-down tag-up) ))
                           )
                           ; this will show tasks with a deadline of 2 days more
                          (org-deadline-warning-days 2)


                          )
                      )
              )
             )

           ; 'In a week' tasks
           ("w" "Week ahead"
              (
               (agenda "" ((org-agenda-span 7)
                           (org-agenda-sorting-strategy
                            (quote ((agenda time-up priority-down tag-up) ))
                            )
                           (org-deadline-warning-days 0)
                           )
                       )
               )
              )

           ;;;;;;;;;;;;;;;;;;;;;;;
           ;; Location/context based queries
           ;;;;;;;;;;;;;;;;;;;;;;;

           ; only shows home tagged entries
           ("h" "At home" tags-todo "+home-backlog"
             (
               (org-agenda-overriding-header "Home")
             )
           )

           ; only shows outside tagged entries
           ("o" "Outside tasks" tags-todo "+outside-backlog"
             (
               (org-agenda-overriding-header "Outside")
             )
           )

           ;;;;;;;;;;;;;;;;
           ; backlog entries
           ("b" "Backlog entries" tags-todo "+backlog-objetivos-calendar"
             (
               (org-agenda-overriding-header "Backlog")
             )
           )

       )
  )
)
#+end_src

*** Show next 15 days in the agenda view
I need a more clear view for things to come. We can see 15 days from now.

#+begin_src emacs-lisp
(after! org
  (setq org-agenda-span 15)
  (setq org-agenda-start-on-weekday nil)
  )
#+end_src

*** Show the agenda in another window
I want to see the agenda side by side of the files I'm working with.
#+begin_src emacs-lisp
(setq org-agenda-window-setup 'reorganize-frame)
#+end_src

** Refile entries
This lets you choose refiling targets in heading depth of 9, and lets you get also the files in the same directory hierarchy.

#+begin_src emacs-lisp
(after! org
  (setq org-refile-targets '(
                             (nil :maxlevel . 9)
                             (org-agenda-files :maxlevel . 9)
                             ("referencias.org" :maxlevel . 9)
                             ("maybe.org" :maxlevel . 9)
                             ("books.org" :maxlevel . 9)
                             ("~/Nextcloud/escritura/retazos/ideas.org" :maxlevel . 9)
                             )
        )
  ;; Refile in a single go
  (setq org-outline-path-complete-in-steps nil)
  ;; Show full paths for refiling
  (setq org-refile-use-outline-path t)
  )
#+end_src

** Exporting org mode
All the functions defined for the org mode export

*** Remove the "validate" link from html exports
#+begin_src emacs-lisp
(after! org
  ;; don't show the "validate" link on org-html exports
  (setq org-html-validation-link nil)
  )
#+end_src

*** Ignore exporting some headlines (just the headlines)
This allows headlines to be ignored in the exports. To do so, the ignore tag (C-c C-c ignore) has to be in the header to be ignored. *We only ignore the headlines, the content is still shown.*

#+begin_src emacs-lisp
(after! org
  (load "~/Nextcloud/config/.emacs.d/vendor/ox-extra/ox-extra.el")
  (require 'ox-extra)
  (ox-extras-activate '(ignore-headlines))
  )
#+end_src

*** Export to Markdown
Export to markdown

#+begin_src emacs-lisp
(after! org
  (require 'ox-md)
  )
#+end_src

*** Export to Latex
All the latex exports

**** TODO Memoir class for org2latex (complete these options)
memoir is a class used to create beautiful documents.

#+begin_src emacs-lisp
(after! org
  (add-to-list 'org-latex-classes
       '("memoir"
                 "\\documentclass[a4paper,17pt,openright,twoside]{memoir}
  \\usepackage{ucs}
  \\usepackage[utf8]{inputenc}
  \\usepackage[spanish]{babel}
  \\usepackage{fontenc}
  \\usepackage{graphicx}

  \% Para poner notas en los márgenes
  \\usepackage{todonotes}

  \% Para tachar palabras
  \\usepackage[normalem]{ulem}

  \\usepackage{hyperref}
  \\usepackage{parskip}
  \\usepackage{fourier}

  \\renewcommand*\\rmdefault{put}

  \\newcommand{\\fin}{\\plainbreak*{3}}

  % command to add edit notes with tiny size
  \\newcommand{\\edit}[1] {\\todo[inline]{#1}}
  \\newcommand{\\adendo}[1] {\\todo[size=\\tiny]{#1}}

  % Chapter style
   \\chapterstyle{dash}

  % How the page is formatted
    \\pagestyle{Ruled}



                 [NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]"
                 ("\\part{%s}" . "\\part*{%s}")
                 ("\\chapter{%s}" . "\\chapter*{%s}")
                 ("\\section*{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
               )
)
#+end_src

**** TODO Memoir_draft class for org2latex (complete these options)
memoir is a class used to create beautiful documents.

#+begin_src emacs-lisp
(after! org
  (add-to-list 'org-latex-classes
       '("memoir_draft"
                 "\\documentclass[a4paper,17pt,draft,openright,twoside]{memoir}
  \\usepackage{ucs}
  \\usepackage[utf8]{inputenc}
  \\usepackage[spanish]{babel}
  \\usepackage{fontenc}
  \\usepackage{graphicx}

  \% Para poner notas en los márgenes
  \\usepackage{todonotes}

  \% Para tachar palabras
  \\usepackage[normalem]{ulem}

  \\usepackage{hyperref}
  \\usepackage{parskip}
  \\usepackage{fourier}

  \\renewcommand*\\rmdefault{put}

  \\newcommand{\\fin}{\\plainbreak*{3}}

  \% command to add edit notes with tiny size
  \\newcommand{\\edit}[1] {\\todo[inline]{#1}}
  \\newcommand{\\adendo}[1] {\\todo[size=\\tiny]{#1}}

  \% Chapter style
  \\chapterstyle{dash}

  \% How the page is formatted
  \\pagestyle{Ruled}





                 [NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]"
                 ("\\part{%s}" . "\\part*{%s}")
                 ("\\chapter{%s}" . "\\chapter*{%s}")
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection*{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection*{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph*{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph*{%s}" . "\\subparagraph*{%s}"))
               )
)
#+end_src

**** TODO Memoir_chapter class for org2latex (complete these options)
Same as memoir class, but it start just with chapters, no "part"

#+begin_src emacs-lisp
(after! org
  (add-to-list 'org-latex-classes
       '("memoir_chapter"
                 "\\documentclass[a4paper,17pt,openright,twoside]{memoir}
  \\usepackage{ucs}
  \\usepackage[utf8]{inputenc}
  \\usepackage[spanish]{babel}
  \\usepackage{fontenc}
  \\usepackage{graphicx}

  \\usepackage{hyperref}
  \\usepackage{parskip}
  \\usepackage{fourier}

  \\renewcommand*\\rmdefault{put}

  \\newcommand{\\fin}{\\plainbreak*{3}}

  % Chapter style
   \\chapterstyle{dash}

  % How the page is formatted
    \\pagestyle{Ruled}



                 [NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]"

                 ("\\chapter{%s}" . "\\chapter*{%s}")
                 ("\\section*{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
               )
)
#+end_src

**** TODO Memoir_chapter_draft class for org2latex (complete these options)
Same as memoir class, but it start just with chapters, no "part"

#+begin_src emacs-lisp
(after! org
  (add-to-list 'org-latex-classes
       '("memoir_chapter_draft"
                 "\\documentclass[a4paper,17pt,draft,openright,twoside]{memoir}
  \\usepackage{ucs}
  \\usepackage[utf8]{inputenc}
  \\usepackage[spanish]{babel}
  \\usepackage{fontenc}
  \\usepackage{graphicx}

  \% Para poner notas en los márgenes
  \\usepackage{todonotes}

  \% Para tachar palabras
  \\usepackage[normalem]{ulem}

  \\usepackage{hyperref}
  \\usepackage{parskip}
  \\usepackage{fourier}

  \\renewcommand*\\rmdefault{put}

  \\newcommand{\\fin}{\\plainbreak*{3}}

  \% command to add edit notes with tiny size
  \\newcommand{\\edit}[1] {\\todo[inline]{#1}}
  \\newcommand{\\adendo}[1] {\\todo[size=\\tiny]{#1}}

  \% Chapter style
  \\chapterstyle{dash}

  \% How the page is formatted
  \\pagestyle{Ruled}





                 [NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]"

                 ("\\chapter{%s}" . "\\chapter*{%s}")
                 ("\\section{%s}" . "\\section*{%s}")
                 ("\\subsection*{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection*{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph*{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph*{%s}" . "\\subparagraph*{%s}"))
               )
)
#+end_src

**** TODO reporting class for org2latex (complete these options)


#+begin_src emacs-lisp
(after! org
  (add-to-list 'org-latex-classes
       '("reporting"
                 "\\documentclass[a4paper,17pt,openright,twoside]{article}
  \\usepackage{ucs}
  \\usepackage[utf8]{inputenc}
  \\usepackage[spanish]{babel}
  \\usepackage{fontenc}
  \\usepackage{graphicx}

  \% Para poner notas en los márgenes
  \\usepackage{todonotes}

  \% Para tachar palabras
  \\usepackage[normalem]{ulem}

  \\usepackage{hyperref}
  \\usepackage{parskip}
  \\usepackage{fourier}

  \\renewcommand*\\rmdefault{put}

  \\newcommand{\\fin}{\\plainbreak*{3}}

  \% command to add edit notes with tiny size
  \\newcommand{\\edit}[1] {\\todo[inline]{#1}}
  \\newcommand{\\adendo}[1] {\\todo[size=\\tiny]{#1}}




                 [NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]"
                 ("\\part{%s}" . "\\part*{%s}")
                 ("\\chapter{%s}" . "\\chapter*{%s}")
                 ("\\section*{%s}" . "\\section*{%s}")
                 ("\\subsection{%s}" . "\\subsection*{%s}")
                 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                 ("\\paragraph{%s}" . "\\paragraph*{%s}")
                 ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))
               )
)
#+end_src

**** Smart quotes
Add smart quotes for latex

#+begin_src emacs-lisp
(after! org
  (setq org-export-with-smart-quotes t)
  )
#+end_src

*** orgmode
We can export a document to org mode

#+begin_src emacs-lisp
(after! org
  (require 'ox-org)
  )
#+end_src

*** Beamer

#+begin_src emacs-lisp
(after! org
  (require 'ox-beamer)
  (require 'ox-latex)
  (setq org-export-allow-bind-keywords t)
  (setq org-latex-listings 'minted)
  (add-to-list 'org-latex-packages-alist '("" "minted"))
  (org-babel-do-load-languages 'org-babel-load-languages '(
     (shell . t)
     (python . t)
     (C . t)
     (ruby . t)
     (js . t)
     (ditaa . t)
     (gnuplot . t)
     )
  )
  (setq org-latex-pdf-process
        '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
          "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"))
  )
#+end_src

*** ditaa location
https://github.com/stathissideris/ditaa
emacs can't find ditaa, so we have to specify the right location ourselves.

#+begin_src emacs-lisp
(setq org-ditaa-jar-path "/usr/bin/ditaa")
#+end_src

** TODO Capture templates
Here I will add template captures for doing several things:

#+begin_src emacs-lisp
(after! org
  (setq org-capture-templates'(

                               ;; task related captures
                               ("i" "Inbox (tasks)" entry
                                (file+headline "~/Nextcloud/agenda/tasks.org" "Inbox")
                                "* TODO %i%? \nEntered on %U"
                                :empty-lines-after 2)

                               ;; Writing related things

                               ;; ;; writing ideas
                               ("I" "Writing idea." entry
                                (file+headline "~/Nextcloud/escritura/retazos/ideas.org" "otras")
                                "** %i%? \nEntered on %U"
                                :empty-lines-after 2)

                               ;; ;; Character idea
                               ("p" "Personaje" entry
                                (file "~/Nextcloud/escritura/retazos/personajes.org")
                                "* %i%? \nEntered on %U"
                                :empty-lines-after 1)

                               ;; ;; all other writing snippets I want to keep
                               ("h" "Compost heap" item
                                (file+headline "~/Nextcloud/escritura/retazos/compost_heap.org" "Compost heap")
                                "- %i%?"
                                :empty-lines-after 1)

                               )
        )
  )

  ;; (setq org-capture-templates'(
  ;;                              ("t" "My TODO task format." entry
  ;;                               (file+headline "~/Nextcloud/agenda/inbox.org" "Tasks")
  ;;                               "** TODO %i%? %^g \n%U"
  ;;                               :empty-lines-after 1)

  ;;                              ("c" "New calendar entry." entry
  ;;                               (file+headline "~/Nextcloud/agenda/tasks.org" "Calendar")
  ;;                               "** TODO %i%?\nSCHEDULED: %^t\n"
  ;;                               :empty-lines-after 1)

  ;;                              ;; Writing related things
  ;;                              ("i" "Writing idea." entry
  ;;                               (file+headline "~/Nextcloud/escritura/ideas/ideas.org" "otras")
  ;;                               "** TODO %?\n*** Personajes\n- \n*** Ambientación\n*** Eventos\n"
  ;;                               :empty-lines-after 1)

  ;;                              ("P" "Personaje" entry
  ;;                               (file "~/Nextcloud/escritura/ideas/personajes.org")
  ;;                               "* "
  ;;                               :empty-lines-after 1)

  ;;                              ("h" "Compost heap" item
  ;;                               (file+headline "~/Nextcloud/escritura/ideas/compost_heap.org" "Compost heap")
  ;;                               "%i"
  ;;                               :empty-lines-after 1)

  ;;                              ("r" "Note and misc content." entry
  ;;                               (file+headline "~/Nextcloud/agenda/inbox.org" "Notes")
  ;;                               "** %i%?\n"
  ;;                               :empty-lines-after 1)

  ;;                              ;; books to read
  ;;                              ("b" "Manual book entry" entry (file "~/Nextcloud/agenda/books.org")
  ;;                               "* %^{TITLE}\n:PROPERTIES:\n:ADDED: %<[%Y-%02m-%02d]>\n:END:%^{AUTHOR}p\n%?" :empty-lines 1)

  ;;                              ;; this one adds a book from an URL, *but you have to have the URL already in the kill ring* or it won't work
  ;;                              ("B" "Book with URL" entry (file "~/Nextcloud/agenda/books.org")
  ;;                               "%(let* ((url (substring-no-properties (current-kill 0)))
  ;;                 (details (org-books-get-details url)))
  ;;            (when details (apply #'org-books-format 1 details)))")

  ;; ;;     ("b" "books to read." entry
  ;; ;;       (file+headline "~/Nextcloud
  ;;                             /agenda/books.org" "Books")
  ;;       "* %^{Title}  %^g
  ;;       %i
  ;;       *Author(s):* %^{Author}
  ;;       ")

  ;; linea en tabla
  ;;  ("w" "peso" table-line
  ;;     (file+headline "~/Nextcloud/personal/peso.org" "peso")
  ;;     "|%<%Y/%m/%d>|%i|")

  ;;    )
  ;; )
#+end_src

** TODO custom tags
Create custom tags for different categories and contexts

#+begin_src emacs-lisp
(after! org
  (setq org-tag-alist '(
                        ;; Contexts based on locations
                        ("work" . ?W) ("home" . ?h)  ("outside" . ?o)
                        ;; Contexts based on tools
                        ("computer" . ?c) ("mobile" . ?m)  ("penpaper" . ?p)
                        ;; Contexts based on activities
                        ("emacs" . ?e)  ("writing" . ?w) ("reading" . ?r)
    )
  )
)
#+end_src

** Remove the markup indicators
No need to see the markup indicators when writing.

#+begin_src emacs-lisp
(after! org
  (setq org-hide-emphasis-markers t)
)
#+end_src

** org-appear
/Hides/ the *emphasis* marks +of+ from orgmode, until you are on them.
#+begin_src emacs-lisp :tangle packages.el
(package! org-appear
  :recipe (:host github
           :repo "awth13/org-appear"))
#+end_src

#+begin_src emacs-lisp
  (use-package org-appear
    :hook (org-mode . org-appear-mode)
    )
#+end_src

** org word count
https://lists.gnu.org/archive/html/emacs-orgmode/2011-04/msg00713.html
#+begin_src emacs-lisp :tangle packages.el
(package! org-wc
  :recipe (:host github :repo "tesujimath/org-wc"))
#+end_src

** org-ql
Better queries for org-ql.

#+begin_src emacs-lisp :tangle packages.el
(package! org-ql
  :recipe (:host github :repo "alphapapa/org-ql"))
#+end_src

** org-roam
Org-roam related config.

#+begin_src emacs-lisp
(after! org-roam
  (setq org-roam-v2-ack t)
  (setq org-roam-directory (file-truename "~/Nextcloud/personal/roam"))

  ;; ("C-c n l" . org-roam-buffer-toggle)
  ;; ("C-c n f" . org-roam-node-find)
  ;; ("C-c n i" . org-roam-node-insert)
  ;; ("C-c n c" . org-roam-capture)
  ;; :map org-roam-dailies-map
  ;; ("Y" . org-roam-dailies-capture-yesterday)
  ;; ("T" . org-roam-dailies-capture-tomorrow)
  ;; :bind-keymap
  ;; ("C-c n d" . org-roam-dailies-map)

  ;; provide org-roam completion links outside org files.
  (setq org-roam-completion-everywhere t)
  ;; Location of the roam database
  (setq org-roam-db-location (file-truename "~/Nextcloud/personal/roam/org-roam.db"))
  ;; Ensure the keymap is available
  ;;(require 'org-roam-dailies)
  ;; org-roam export: https://www.orgroam.com/manual.html#org_002droam_002dexport
  ;;      (require 'org-roam-export)
  ;; autosync
  (org-roam-db-autosync-mode 1)
  )
#+end_src

*** org-roam templates
#+begin_src emacs-lisp
(setq org-roam-capture-templates
      '(
        ;; default template
        ("d" "default" plain
         "* TODO ${title}\n%?"
         :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
         :unnarrowed t)
        ("b" "book notes" plain (file "~/.doom.d/roamtemplates/BookNoteTemplate.org")
         :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n#+filetags: book")
         :unnarrowed t)
        ("w" "writing idea" plain (file "~/.doom.d/roamtemplates/WritingIdea.org")
         :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n#+filetags: writing")
         :unnarrowed t)
        ("c" "writing character" plain (file "~/.doom.d/roamtemplates/CharacterIdea.org")
         :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n#+filetags: writing character")
         :unnarrowed t)
        )
      )
#+end_src

*** Search by title and tags
To search by title and tags, we will use the information contained here:

https://github.com/org-roam/org-roam/pull/2054
#+begin_src emacs-lisp
(after! org-roam
(setq org-roam-node-display-template
      (concat "${title:*} "
              (propertize "${tags:20}" 'face 'org-tag)))
)
#+end_src

*** Search using content or roam using ripgrep
This does full text search on my roam notes.

#+begin_src emacs-lisp
(after! org-roam
(defun my/org-roam-rg-search ()
  "Search org-roam directory using consult-ripgrep. With live-preview."
  (interactive)
  (let ((consult-ripgrep-command "rg --null --ignore-case --type org --line-buffered --color=always --max-columns=500 --no-heading --line-number . -e ARG OPTS"))
    (consult-ripgrep org-roam-directory)))
(global-set-key (kbd "C-c rr") 'my/org-roam-rg-search)
)
#+end_src

*** Dailies config
#+begin_src emacs-lisp
(after! org-roam
;; Daily notes for org-roam
;; Directory is relative to org-roam-directory
(setq org-roam-dailies-directory "daily/")

;; Capture template for the dailies
(setq org-roam-dailies-capture-templates
      '(("d" "default" entry
         "* %?"
         :if-new (file+head "%<%Y-%m-%d>.org"
                            "#+title: %<%Y-%m-%d>\n#+filetags: daily\n"))))
)
#+end_src

*** org-roam-ui
Load org-roam UI and all its dependencies.

#+begin_src emacs-lisp :tangle packages.el
(package! org-roam-ui
  :recipe (:host github :repo "org-roam/org-roam-ui")
  )
#+end_src

#+begin_src emacs-lisp
(after! org-roam
(use-package! org-roam-ui
  ;;:after org-roam
  :hook (org-roam . org-roam-ui-mode)
  )
)
#+end_src

*** org-roam TODOs to the agenda
I want to get all my org-roam TODOs in the agenda view, but I need to do it only with the files that contain the TODO keywords, and not the whole org-roam directory.

TODO: I need to activate this only for my personal profile, and not my work profile

https://d12frosted.io/posts/2021-01-16-task-management-with-roam-vol5.html

#+begin_src emacs-lisp
(after! org-roam

;; Load this only on my personal profile, and not in my work one
  (if my-homeenvironment-p
         (progn



  ;; we want to load these functions if org-roam is present
  (if (not(require 'org-roam nil t))
          ;; if condition
          (message "org-roam not found")
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;; else condition

    (setq my/roamtag "roamtag")

    (defun vulpea-buffer-prop-set (name value)
        "Set a file property called NAME to VALUE in buffer file.
          If the property is already set, replace its value."
        (setq name (downcase name))
        (org-with-point-at 1
          (let ((case-fold-search t))
            (if (re-search-forward (concat "^#\\+" name ":\\(.*\\)")
                                   (point-max) t)
                (replace-match (concat "#+" name ": " value) 'fixedcase)
              (while (and (not (eobp))
                          (looking-at "^[#:]"))
                (if (save-excursion (end-of-line) (eobp))
                    (progn
                      (end-of-line)
                      (insert "\n"))
                  (forward-line)
                  (beginning-of-line)))
              (insert "#+" name ": " value "\n")))))

    (defun vulpea-buffer-prop-set-list (name values &optional separators)
      "Set a file property called NAME to VALUES in current buffer.
          VALUES are quoted and combined into single string using
          `combine-and-quote-strings'.
          If SEPARATORS is non-nil, it should be a regular expression
          matching text that separates, but is not part of, the substrings.
          If nil it defaults to `split-string-default-separators', normally
          \"[ \f\t\n\r\v]+\", and OMIT-NULLS is forced to t.
          If the property is already set, replace its value."
      (vulpea-buffer-prop-set
       name (combine-and-quote-strings values separators)))

    (defun vulpea-buffer-tags-set (&rest tags)
      "Set TAGS in current buffer.
            If filetags value is already set, replace it."
      (vulpea-buffer-prop-set "filetags" (string-join tags " ")))

    (defun vulpea-buffer-prop-get (name)
      "Get a buffer property called NAME as a string."
      (org-with-point-at 1
        (when (re-search-forward (concat "^#\\+" name ": \\(.*\\)")
                                 (point-max) t)
          (buffer-substring-no-properties
           (match-beginning 1)
           (match-end 1)))))


    (defun vulpea-buffer-prop-get-list (name &optional separators)
      "Get a buffer property NAME as a list using SEPARATORS.
              If SEPARATORS is non-nil, it should be a regular expression
              matching text that separates, but is not part of, the substrings.
              If nil it defaults to `split-string-default-separators', normally
              \"[ \f\t\n\r\v]+\", and OMIT-NULLS is forced to t."
      (let ((value (vulpea-buffer-prop-get name)))
        (when (and value (not (string-empty-p value)))
          (split-string-and-unquote value separators))))

    (defun vulpea-buffer-tags-get ()
      "Return filetags value in current buffer."
      (vulpea-buffer-prop-get-list "filetags" " "))

    (defun vulpea-buffer-tags-add (tag)
      "Add a TAG to filetags in current buffer."
      (let* ((tags (vulpea-buffer-tags-get))
             (tags (append tags (list tag))))
        (apply #'vulpea-buffer-tags-set tags)))



    (defun vulpea-project-p ()
      "Return non-nil if current buffer has any todo entry.

                  TODO entries marked as done are ignored, meaning the this
                  function returns nil if current buffer contains only completed
                  tasks."
      (seq-find                                 ; (3)
       (lambda (type)
         (eq type 'todo))
       (org-element-map                         ; (2)
           (org-element-parse-buffer 'headline) ; (1)
           'headline
         (lambda (h)
           (org-element-property :todo-type h)))))

    (defun vulpea-project-update-tag ()
      "Update PROJECT tag in the current buffer."
      (when (and (not (active-minibuffer-window))
                 (vulpea-buffer-p))
        (save-excursion
          (goto-char (point-min))
          (let* ((tags (vulpea-buffer-tags-get))
                 (original-tags tags))
            (if (vulpea-project-p)
                (setq tags (cons "roamtag" tags))
              (setq tags (remove "roamtag" tags)))

            ;; cleanup duplicates
            (setq tags (seq-uniq tags))

            ;; update tags if changed
            (when (or (seq-difference tags original-tags)
                      (seq-difference original-tags tags))
              (apply #'vulpea-buffer-tags-set tags))))))

    (defun vulpea-buffer-p ()
      "Return non-nil if the currently visited buffer is a note."
      (and buffer-file-name
           (string-prefix-p
            (expand-file-name (file-name-as-directory org-roam-directory))
            (file-name-directory buffer-file-name))))

    (defun vulpea-project-files ()
      "Return a list of note files containing 'roamtag' tag." ;
      (seq-uniq
       (seq-map
        #'car
        (org-roam-db-query
         [:select [nodes:file]
                  :from tags
                  :left-join nodes
                  :on (= tags:node-id nodes:id)
                  :where (like tag (quote "%\"roamtag\"%"))]))))

    ;; This will overwrite the current agenda files, and we don't want that
    (defun vulpea-agenda-files-update (&rest _)
      "Update the value of `org-agenda-files'."
      (setq org-agenda-files (vulpea-project-files)))

    (defun inject-vulpea-project-files (org-agenda-files)
      (append org-agenda-files (vulpea-project-files)))
    (advice-add 'org-agenda-files :filter-return #'inject-vulpea-project-files)

    (add-hook 'find-file-hook #'vulpea-project-update-tag)
    (add-hook 'before-save-hook #'vulpea-project-update-tag)

    ;; original code that overwrites the agenda files
    ;;  (advice-add 'org-agenda :before #'vulpea-agenda-files-update)
    ;;  (advice-add 'org-todo-list :before #'vulpea-agenda-files-update)
    )
  ))
  )
#+end_src

* Writing
** Word count
Word counting with objective.
I don't know if this is shown in the doom modeline. Also, it makes it really slow with big files.

#+begin_src emacs-lisp :tangle packages.el
;; (package! wc-mode
;;   :recipe (:host github :repo "bnbeckwith/wc-mode"))
#+end_src

#+begin_src emacs-lisp
;; (global-set-key (kbd "C-c 9") 'wc-mode)
;; (setq doom-modeline-enable-word-count nil)
#+end_src

** word count track table
A table to track the advance of your writing
https://github.com/tty-tourist/org-tracktable

#+begin_src emacs-lisp :tangle packages.el
(package! org-tracktable
  :recipe (:host github :repo "tty-tourist/org-tracktable"))
#+end_src

#+begin_src emacs-lisp
(global-set-key (kbd "C-c 3") 'org-tracktable-status)
(global-set-key (kbd "C-c 4") 'org-tracktable-write)
#+end_src

** zen writing adjustments
Adjustments done to the zen mode for better visibility
#+begin_src emacs-lisp
(setq +zen-text-scale 2)
(setq writeroom-width 0.1)
#+end_src

** org-journal
This is for journaling every day, if possible.
Documentation can be found here:

https://github.com/bastibe/org-journal

#+begin_src emacs-lisp
;;("C-c r ñ" . org-journal-new-entry)
(setq org-journal-date-prefix "#+TITLE: ")
(setq org-journal-file-format "%Y-%m-%d.org")
(setq org-journal-dir "~/Nextcloud/personal/diario/")
(setq org-journal-date-format "%A, %d %B %Y")
(setq org-journal-encrypt-journal nil)
#+end_src

** Buscar en la RAE
Seach a word in the spanish dictionary.

#+begin_src emacs-lisp
(defun my/buscarae (palabra)
  "Busca una palabra en la RAE."
  (interactive "s¿Qué palabra quieres buscar? ")
  (eww (concat "https://dle.rae.es/" palabra))
  )
#+end_src

** Buscar sinónimos
Seach a synonim.

#+begin_src emacs-lisp
(defun my/sinonimo (palabra)
  "Busca una palabra en un diccionario de sinónimos"
  (interactive "s¿Qué palabra quieres buscar? ")
  (eww (concat "https://www.wordreference.com/sinonimos/" palabra))
  )
#+end_src

** Translate from english
Translate a word

#+begin_src emacs-lisp
(defun my/translate (palabra)
  "Traduccion de inglés a español"
  (interactive "s¿Qué palabra quieres buscar? ")
  (eww (concat "https://www.deepl.com/translator#en/es/" palabra))
  )
#+end_src

** Create a story file on the fly
Sometimes I want to create

#+begin_src emacs-lisp
(defvar my/stories-directory "~/Nextcloud/escritura/historias/ejercicios"
  "Directory where org files created by `my/create-org-file' will be stored.")

(defun my/create-empty-writing-file (text)
  "Create a new org file with name format `%Y%m%d-<text>.org', where <text> is the `text' argument with spaces replaced by underscores. The file will be stored in `my/stories-directory'."
  (interactive "sEnter file name: ")
  (let* ((date (format-time-string "%Y%m%d"))
         (filename (concat date "-" (replace-regexp-in-string " " "_" text) ".org"))
         (full-path (concat my/stories-directory "/" filename)))
    (find-file full-path)))

(defun my/create-writing-exercise (text)
  "Create a new file with the current date and the specified TEXT.
The file is saved in the directory specified by `my/stories-directory'.
The file name format is \"%Y%m%d-<text>.org\", with spaces in TEXT replaced by \"_\".
The function runs a Python script that generates a writing prompt
and stores the output in the file."
  (interactive "sEnter file name: ")
  (let* ((date (format-time-string "%Y%m%d"))
         (file-name (concat date "-" (replace-regexp-in-string " " "_" text) ".org"))
         (file-path (concat my/stories-directory "/" file-name))
         (python-output (shell-command-to-string "python  ~/Nextcloud/escritura/software/writing_companion/writing_companion.py -s all prompt")))
    (with-temp-file file-path
      (insert "#+TITLE: " text "\n\n" python-output))
    (find-file file-path)
    ))
#+end_src

* Others
** theme changer
I will write a function to change themes from a list.
#+begin_src emacs-lisp
;; This is the list of themes I want to apply and rotate
(defvar my/themes '(
                    ;; dark themes
                    ef-dark
                    leuven-dark
                    ;; light themes
                    leuven
                    ef-light
                    )
  "Stores the themes we want to change to.
The theme enabled will be the first of the list,
and then it will be pushed to the end of the list.
This way, we rotate the themes."
  )


(defun my/theme-changer()
  "Given a list of themes, it get the first one, applies it and adds it back to the list.

        The result is that we can rotate from a custom list of themes."
  (interactive)
  ;; obtain the first item of the list, extract it, apply it, and put it back to the end of the list
  (setq my/first-theme (car my/themes))
  ;;(message "theme is %s" my/first-theme)
  (setq my/themes
        (nconc (last my/themes) (butlast my/themes)))
                                        ;(disable-theme doom-theme)
                                        ;(enable-theme my/first-theme)
  (consult-theme my/first-theme)
  (message "Applied the theme %s" my/first-theme)
  )

(global-set-key (kbd "C-c 0") 'my/theme-changer)
#+end_src

* Testing
** projectile file
Store my personal projects in the sync directory.

#+begin_src emacs-lisp
;; Load this only when it is my home environment
(if (not my-workenvironment-p)
    (setq projectile-known-projects-file "~/Nextcloud/config/.emacs.d/projectile.projects")
    )
#+end_src
** nov.el
To read epub inside emacs.

#+begin_src emacs-lisp :tangle packages.el
;; required for the nov.el package
(package! esxml)
(package! nov.el)
#+end_src


#+begin_src emacs-lisp
;; Add the epub files to the nov-mode
(add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode))

;; Nov.el font configuration
(defun my-nov-font-setup ()
  (face-remap-add-relative 'variable-pitch
;;                           :family "Liberation Serif"
                           :family "ETBembo"
                           :height 1.0))
(add-hook 'nov-mode-hook 'my-nov-font-setup)

;; keep the text width to a readable number
(setq nov-text-width 80)

#+end_src

** TODO treemacs config

To change to the treemacs window, check this: https://github.com/doomemacs/doomemacs/issues/1177

#+begin_src emacs-lisp
;; where to store the persistant information
;; only for home computer
(if (not my-worksystem-p)
    (progn
      (setq treemacs-persist-file (expand-file-name "treemacs-persist" my-data-dir))
      )
  )
;; indenting the treemacs tree structure
(setq treemacs-indent-guide-mode t)

;; this function allows for jumping back and forth from the treemacs window
(require 'treemacs)
(defun my/treemacs-back-and-forth ()
  "Allows jumping back and forth the treemacs window if it exists,
or open the treemacs, if it doesn't"
  (interactive)
  (if (treemacs-is-treemacs-window-selected?)
      ;; then part
      (progn
        (other-window 1)
        ;;(aw-flip-window)
        ;;(treemacs-select-window)
        )
    ;; else part
    (   progn
      (treemacs-select-window)
      )
    )
  )

;; map a keybinding to this function
(global-set-key (kbd "C-c o t") 'my/treemacs-back-and-forth)
#+end_src

** org-remark
Annotate any file in an accesory file.
https://github.com/nobiot/org-remark
https://nobiot.github.io/org-remark/

#+begin_src emacs-lisp :tangle packages.el
(package! org-remark
  :recipe (:host github :repo "nobiot/org-remark"))
#+end_src

#+begin_src emacs-lisp
(after! org
  (require 'org-remark)
  (require 'org-remark-global-tracking)
  (org-remark-global-tracking-mode +1)


  ;; Create a file of notes for each file, with the buffer name
  (defun my/org-remark-file-name ()
    (concat (file-name-base (org-remark-notes-file-name-function))
            ".org"))

  (setq org-remark-notes-file-name
        #'my/org-remark-file-name)

  ;; Create highlighter pens for different parts
  ;; Since I use alternate dark and clear themes, these must be useful for both
  (org-remark-create "blue"
                     '(:underline "sky blue" :background "deep sky blue")
                     '(CATEGORY "editing"))

  ;; can be properly seen in both dark and clear themes
  (org-remark-create "dark-blue-line"
                     '(:underline "deep sky blue")
                     '(CATEGORY "editing"))

  (org-remark-create "boring-gray"
                     '(:background "dim gray"))

  (org-remark-create "salmon"
                     '(:background "salmon"))

  (org-remark-create "royal-blue"
                     '(:background "royal blue"))

  ;; Key-bind `org-remark-mark' to global-map so that you can call it
  ;; globally before the library is loaded.
  (define-key global-map (kbd "C-c m m") #'org-remark-mark)
  (define-key global-map (kbd "C-c m o") #'org-remark-open)
  (define-key global-map (kbd "C-c m n") #'org-remark-view-next)
  (define-key global-map (kbd "C-c m p") #'org-remark-view-prev)
  (define-key global-map (kbd "C-c m r") #'org-remark-remove)
  (define-key global-map (kbd "C-c m j") #'org-remark-change)
  (define-key global-map (kbd "C-c m b") #'org-remark-mark-blue)

  ;; The remark file will be named based on the original file


  )
#+end_src

** TODO org-ref
For bibliographical references
#+begin_src emacs-lisp :tangle packages.el
(package! org-ref
  :recipe (:host github :repo "jkitchin/org-ref"))
#+end_src

** Bibtex
Bibliography code for citations.

Changing the dialect to biblatex.
#+begin_src emacs-lisp
;; BibLaTeX settings
;; bibtex-mode
(setq bibtex-dialect 'biblatex)
#+end_src

Defining the variables for bib files location.
#+begin_src emacs-lisp
(setq bib-files-directory (directory-files
                           "/home/jcastp/Nextcloud/escritura/bibliography/" t
                           "^[A-Z|a-z].+.bib$")
      pdf-files-directory "/home/jcastp/Nextcloud/escritura/bibliography/"
      )
#+end_src

** TODO org-cv
To create a CV based on the orgmode cv
https://gitlab.com/Titan-C/org-cv

#+begin_src emacs-lisp :tangle packages.el
(package! org-cv
  :recipe (:host gitlab :repo "Titan-C/org-cv"))
#+end_src


** dimmer
Dim the inactive buffers.
https://github.com/gonewest818/dimmer.el

#+begin_src emacs-lisp :tangle packages.el
(package! dimmer)
#+end_src

#+begin_src emacs-lisp
(dimmer-mode t)
(setq dimmer-adjustment-mode :both)
(setq dimmer-fraction 0.2)
#+end_src

** TODO random org-roam node to complete
I will write a function to
#+begin_src emacs-lisp
(after! org-roam
(defun my/random-roam ()
  "Selects and opens a random org-roam node with the TODO keyword."
  (interactive)
  ()
    )
  )
#+end_src

** No line highlighting
I find the line highlight distracting

#+begin_src emacs-lisp
;; to avoid hl-line-mode to be activaded no matter how
(remove-hook 'doom-first-buffer-hook #'global-hl-line-mode)
(setq global-hl-line-modes nil)
(global-hl-line-mode -1)
#+end_src

** org-pov
#+begin_src emacs-lisp
(defun parse-org-buffer ()
  "Parse the current org-mode buffer and show a table of headings and POV values."
  (interactive)
  (let ((table-data (list '("Headings" "POV Values")))
        (headings (org-element-map (org-element-parse-buffer) 'headline
                    (lambda (headline)
                      (let ((heading (org-element-property :title headline))
                            (pov (org-element-property :POV headline)))
                        (when pov
                          (list heading (string-to-number pov))))))))
    (dolist (heading headings)
      (push heading table-data))
    (setq table-data (nreverse table-data))
    (with-output-to-temp-buffer "*org-table*"
      (dolist (row table-data)
        (insert (mapconcat 'identity row "\t") "\n"))))
    (switch-to-buffer "*org-table*"))


#+end_src

* Work environment
This will be my working environment config

#+begin_src emacs-lisp
;; Load this config when using the work computer
(if my-workenvironment-p
    (progn
      (org-babel-load-file "~/.doom.d/emacs-org-init-trabajo.org")
      )
  )
#+end_src

* Export config :ignore:
# ############################
# General options
# ############################
#+OPTIONS: ':t *:t -:t ::t <:t H:3 \n:nil ^:t arch:headline author:t
#+OPTIONS: broken-links:nil c:nil creator:nil d:(not "LOGBOOK")
#+OPTIONS: date:t e:t email:nil f:t inline:t num:t p:nil pri:nil
#+OPTIONS: prop:nil stat:t tags:t tasks:t tex:t timestamp:t title:t
#+OPTIONS: toc:2 todo:t |:t\n
#+EXCLUDE_TAGS: noexport
#+EXPORT_FILE_NAME:

# ######################
# latex related options
# ######################
#+LATEX_CLASS: memoir_draft
#+LATEX_HEADER:
#+LATEX_HEADER_EXTRA:
#+DESCRIPTION:
#+KEYWORDS:
#+SUBTITLE:

# ######################
# odt related options
# ######################
#+OPTIONS: tex:t
#+ODT_STYLES_FILE: "~/Nextcloud/escritura/recursos/orgtemplate2odt.ott"
#+DESCRIPTION:
#+KEYWORDS:
#+SUBTITLE:
#+LATEX_HEADER:

# ######################
# HTML related options
# ######################
#+DESCRIPTION:
#+HTML_DOCTYPE: html5
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="file:///home/jcastp/Nextcloud/config/org.css"/>
#+HTML_HEAD_EXTRA:

# ######################
# epub related options
# ######################
#+UID:
#+Subject:
#+Description:
#+Publisher:
#+License:
#+EPUBSTYLE:
#+EPUBCOVER:
#+HTML_DOCTYPE: xhtml

# Local Variables:
# ispell-local-dictionary: "american"
# End:
